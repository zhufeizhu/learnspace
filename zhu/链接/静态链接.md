# 静态链接

- [COMMON块](#common块)
- [链接过程控制](#链接过程控制)

## COMMON块
其实是一个机制(Fortran的Common block机制) 主要针对弱符号(即为初始化的全局变量),由于强弱符号的存在，在不同目标文件中可能存在着同名的强弱符号，主要有如下三种情况
1. 不同目标文件中有同名强符号 链接时会报错
2. 不同目标文件中有同名强符号和弱符号 链接时会优先选择强符号
3. 不同目标文件中有同名的弱符号 链接时会根据弱符号的大小来进行选择 即COMMON机制

查看目标文件的符号表可以发现对于未初始化的全局变量其为`"COM"`类型,并非和静态局部变量在`.bss`段中,这是因为由于上述第三点的原因 无法在编译时确定该变量的大小，因此也导致了无法在编译阶段确定`.bss`段的大小 但是在链接时可以确定大小后 最终还是存放在`.bss`段

## 链接过程控制
通过ld的参数来自己决定链接后可执行文件的布局 

### lds链接脚本
`ld`通过使用`*.lds`脚本来自定义链接后的目标文件布局 通过`-T`参数来指定链接脚本`ld -T *.lds`

一般lds由如下几个部分构成
命令 | 说明
---- | -----
ENTRY() | 用来指定生成目标文件的入口地址 也可以用`-e`参数来在ld命令中指定且优先级较高
STARTUP() |  用来指定链接过程中的第一个输入文件
SEARCH_DIR | 用来指定查找库的路径
INPUT | 用来指定输入文件
PROVIDE | 定义特殊符号
INCLUDE | 包含其他lds文件
SECTIONS | 指定输出文件的段布局

**SECTIONS用法**
```
SECTIONS{
    . = xxxxx  //用来设置当前的虚拟地址
    secname : { contents } //设置当前段的内容
    /DISCARD/ : {contents}  //设置丢弃段的内容
}
```

`content`的写法有很多种 
1. `mysec : { file1.o(.data) file2.o(.text) }` 表示将`file1.o`的`.data`段和`file2.o`的`.text`段合并到mysec中
2. `/DISCARD/ : { *(.comment)}` 表示丢弃所有输入文件的`.comment`段
3. `mysec : { file1.o file2.o }` 表示将`file1.o`和`file2.o`所有的段合并到`mysec`中